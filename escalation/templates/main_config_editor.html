<!--# Copyright [2020] [Two Six Labs, LLC]-->
<!--# Licensed under the Apache License, Version 2.0-->



{% extends 'base.html' %}

{% block header %}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
{% endblock %}

{% block content %}

<div class="jumbotron">
    <h1 class="display-4">Main Configuration Editor</h1>
    <hr class="my-4">
    <p class="lead">Create/Edit the main config file</p>
</div>
    <div class="container-fluid pl-5 pr-5">
    <div class="row ml-1 mb-4">
        <h2>Data Backend:</h2>
        <select class="selectpicker mt-1 ml-3" data-dropdown-align-right='auto' id="schema_type">
            <option value="database" {% if current_schema == "database" %}  selected {% endif %}>Database</option>
            <option value="local_csv" {% if current_schema == "local_csv" %}  selected {% endif %}>Local</option>
        </select>
    </div>
    <div class="row">
        <div class="col-8" id="editor_holder">
        </div>
        <div class="col-2 text-center">
            {% include "config_buttons.html" %}
        </div>
    </div>
    </div>
<script>
    // Enables all the tooltips
    $(function () {$('[data-toggle="tooltip"]').tooltip({trigger : 'hover'})})

    let current_state = {{ current_config | safe }};
    const dict_of_schemas = {{ schema | safe }};
    let current_schema = "{{ current_schema }}"
    let save_schema = current_schema;
    let editor = {};
    new_json_editor();
    {% if current_config!="{}" %}
        editor.setValue(current_state);
    {% endif %}


    function save_json_editor_to_file(redirect){
        const url = "{{ url_for('.update_main_json_config_with_ui_changes') }}";
        let webpage = ''
        if (redirect) {webpage = '{{ url_for('.file_tree') }}'}
        // The form contains nested dictionaries so it is easier to send a json than a form
        current_state = editor.getValue();
        save_schema = current_schema;
        let data = JSON.stringify(current_state);
        send_json_in_post_request(url, data, webpage);// The form contains nested dictionaries so it is easier to send a json than a form
    }
    function reset_json_editor(){
        editor.setValue()
    }
    function new_json_editor(){
        editor = new JSONEditor(document.getElementById('editor_holder'),
            options={theme: 'bootstrap4',display_required_only: true,disable_edit_json:true,
                disable_array_delete_last_row:true, iconlib: 'fontawesome4', schema: dict_of_schemas[current_schema] });
    }
    function reload_last_save(){
        if (current_schema!=save_schema){
            current_schema=save_schema;
            let element=document.getElementById('schema_type');
            element.value=current_schema;
            element.dispatchEvent(new Event('change'));
            editor.destroy();
            new_json_editor();
        }
        editor.setValue(current_state)

    }
    $("select").on("changed.bs.select",
          function(e, clickedIndex, newValue, oldValue) {
        current_schema=this.value;
        let save=editor.getValue();
        editor.destroy();
        new_json_editor();
        editor.setValue(save);

    });
</script>
{% endblock %}