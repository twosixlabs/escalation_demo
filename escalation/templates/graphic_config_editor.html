<!--# Copyright [2020] [Two Six Labs, LLC]-->
<!--# Licensed under the Apache License, Version 2.0-->

{% extends 'base.html' %}

{% block header %}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
{% endblock %}

{% block content %}

<div class="jumbotron">
    <h1 class="display-4">Graphic Configuration Editor</h1>
    <hr class="my-4">
    <p class="lead">Create/Edit a graphic config file</p>
</div>
    <div class="container-fluid pl-5 pr-5">
    <div class="row">
        <div class="col-8">
            <div class="row">
                <div class="w-100" id="editor_holder_graphic"></div>
            </div>
            <div class="row ml-1 mb-4">
                <h2>Type of Plot:</h2>
                <select class="selectpicker mt-1 ml-3" data-dropdown-align-right='auto'>
                    {% for value, selector_text in schema_selector_dict.items() %}
                        <option value={{ value }}>{{ selector_text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="w-100" id="editor_holder_plotly"></div>
            </div>
            <div class="row">
                <div class="w-100" id="editor_holder_visualization"></div>
            </div>
            <div class="row">
                <div class="w-100" id="editor_holder_selector"></div>
            </div>
        </div>
        <div class="col-2 text-center">
            {% include "config_buttons.html" %}
        </div>
    </div>
    </div>
<script>
    // Enables all the tooltips
    $(function () {$('[data-toggle="tooltip"]').tooltip()})

    let current_state = {{ current_config | safe }};
    const dict_of_schemas={{ schema | safe }};
    const dict_of_plotly_schemas = dict_of_schemas['plotly_schema'];
    let editors= new Object();
    editors['graphic_meta_info'] = new_editor('graphic', false, dict_of_schemas['graphic_schema']);
    editors['plotly'] = new_editor('plotly', true, dict_of_plotly_schemas["{{ current_schema }}"]);
    editors['visualization'] = new_editor('visualization', false, dict_of_schemas["visualization_schema"]);
    editors['selector'] = new_editor('selector', false, dict_of_schemas["selector_schema"]);

    {% if is_graphic_new=='false' %}
        for(let editor_name in editors){
            editors[editor_name].setValue(current_state[editor_name])
        }
    {% endif %}

    function new_editor(type,display_required_only,schema) {
        return new JSONEditor(document.getElementById('editor_holder_'.concat(type)),
        options={theme: 'bootstrap4',display_required_only: display_required_only, disable_edit_json:true, iconlib: 'fontawesome4', schema: schema });
    }
    function save_json_editor_to_file(redirect){
        const url = "{{ url_for('.update_graphic_json_config_with_ui_changes') }}";

        let webpage = '';
        if (redirect) {webpage = "{{ url_for('.file_tree') }}"}
        for(let editor_name in editors){
            current_state[editor_name]=editors[editor_name].getValue();
        }
        // The form contains nested dictionaries so it is easier to send a json than a form
        let data = JSON.stringify({"config_dict" : current_state,
            "page_id":{{ page_id }},
            "graphic": '{{ graphic }}',
            "is_graphic_new":{{ is_graphic_new }}});
        send_json_in_post_request(url, data, webpage);// The form contains nested dictionaries so it is easier to send a json than a form
    }
    function reset_json_editor(){
        for(let editor_name in editors){
            editors[editor_name].setValue();
        }
    }
    function reload_last_save(){
        for(let editor_name in editors){
            editors[editor_name].setValue(current_state[editor_name]);
        }
    }
    $("select").on("changed.bs.select",
          function(e, clickedIndex, newValue, oldValue) {
        let plot_type=this.value;
        let save=editors['plotly'].getValue();
        editors['plotly'].destroy();
        editors['plotly'] = new_editor('plotly',true, dict_of_plotly_schemas[plot_type])

    });
</script>
{% endblock %}